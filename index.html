<!doctype html>

<body>
	<canvas id="render"></canvas>
	<script src="fengari-web.js"></script>
	<script>
		window.lua_callbacks = {}
		var enc = new TextEncoder();
		var dec = new TextDecoder();


		lauxlib = fengari.lauxlib;
		lualib = fengari.lualib;
		lua = fengari.lua;

		LuaString = fengari.to_luastring
		JavascriptString = function JavascriptString(str) {
			return dec.decode(str);
		}

		var newline_replace = /^#[^\n]+/;

		var L = window.L = fengari.L;

		function RunString(L, str) {
			var err = lauxlib.luaL_loadstring(L, LuaString(str.replace(newline_replace, "")));

			if (err !== 0) {
				err = new Error(JavascriptString(lua.lua_tostring(L, -1)));
				lua.lua_pop(L, 1);

				throw err;
			}

			lua.lua_call(L, 0, 0);
		}

		function RunFile(L, fname) {
			return RunString(L, "require(\"" + fname.replace(/"/g, "\\\"") + "\")");
		}

		function ContinueThread(L, nargs) {
			var res;
			if (lua.LUA_YIELD == (res = lua.lua_resume(L, null, nargs || 0))) {
				var str = JavascriptString(lua.lua_tostring(L, 1));
				console.log("yield: " + str);
				lua_callbacks[str](L);
			}
			else if (res != lua.LUA_OK) {
				console.log("error: " + lua.lua_tostring(L, -1));
				lua.lua_pop(L, 1);
			}

		}

		function RunMainThread(Lmain, str) {
			var L = lua.lua_newthread(Lmain);

			var err = lauxlib.luaL_loadstring(L, LuaString(str.replace(newline_replace, "")));

			if (err !== 0) {
				err = new Error(JavascriptString(lua.lua_tostring(L, -1)));
				lua.lua_pop(L, 1);

				throw err;
			}

			ContinueThread(L);
		}
	</script>
	<script src="renderer.js"></script>
	<script>
		console.log( "Starting Application" );
		RunMainThread(L, "dofile'./detours.lua' dofile'./../application.lua'");
	</script>
</body>